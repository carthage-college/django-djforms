{% extends "lis/conferences/course_ference/attender/form.html" %}
{% block body_tag %} onload="loadMap()"{% endblock %}
{% block extra_javascript %}
<!-- Include google map lib -->
<script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyAaLGu4USn43Rh_2crRvRwvnte3wH8Ihww&sensor=false"></script>
<script type="text/javascript">
    // data file with markers (could also be a PHP file for dynamic markers)
    var markerFile = 'https://www.carthage.edu/forms/lis/conferences/course-ference/map/json/';
    // set default map properties
    var defaultLatlng = new google.maps.LatLng(49.00,10.00);
    // zoom level of the map
    var defaultZoom = 2;
    // variable for map
    var map;
    // variable for marker info window
    var infowindow;
    // List with all marker to check if exist
    var markerList = {};
    // option for google map object
    var myOptions = {
        zoom: defaultZoom,
        center: defaultLatlng,
        mapTypeId: google.maps.MapTypeId.HYBRID
    }

    /**
     * Load Map
     */
    function loadMap(){
        // create new map make sure a DIV with id myMap exist on page
        map = new google.maps.Map(document.getElementById("myMap"), myOptions);
        // create new info window for marker detail pop-up
        infowindow = new google.maps.InfoWindow();
        // load markers
        loadMarkers();
    }

    function get_long_lat(jsonobj) {
        // address format = "1600 Amphitheatre Pkwy, Mountain View, CA 94043, USA"
        geocoder = new google.maps.Geocoder();
        geocoder.geocode({address: jsonobj['address']},
            function(results_array, status) {
                jsonobj['lat'] = results_array[0].geometry.location.lat();
                jsonobj['long'] = results_array[0].geometry.location.lng();
                console.log("lat = " + jsonobj['lat'] + " and long = " + jsonobj['long']);
                loadMarker(jsonobj);
        });
        return jsonobj;
    }
    /**
     * Load markers via ajax request from server
     */
    function loadMarkers(){
        // makerFile can be a URL or file
        $.getJSON(markerFile, function(data) {
            // loop all the markers
            $.each(data.markers, function(i,item){
                // add marker to map
                if (item['address']) {
                    //alert(item['address']);
                    get_long_lat(item);
                }else{
                    loadMarker(item);
                }
            });
        });
    }

    /**
     * Load marker to map
     */
    function loadMarker(markerData){

        // create new marker location
        var myLatlng = new google.maps.LatLng(markerData['lat'],markerData['long']);

        // create new marker
        var marker = new google.maps.Marker({
            id: markerData['id'],
            map: map,
            title: markerData['name'] ,
            position: myLatlng
        });

        // add marker to list used later to get content and additional marker information
        markerList[marker.id] = marker;

        // add event listener when marker is clicked
        // currently the marker data contain a dataurl field this can of course be done different
        google.maps.event.addListener(marker, 'click', function() {

            // show marker when clicked
            showMarker(marker.id);

        });

        // add event when marker window is closed to reset map location
        google.maps.event.addListener(infowindow,'closeclick', function() {
            map.setCenter(defaultLatlng);
            map.setZoom(defaultZoom);
        });
    }
    /**
     * Show marker info window
     */
    function showMarker(markerId){
        // get marker information from marker list
        var marker = markerList[markerId];
        // check if marker was found
        if( marker ){
            // get marker detail information from server
            $.get( 'data/' + marker.id + '.html' , function(data) {
                // show marker window
                infowindow.setContent(data);
                infowindow.open(map,marker);
            });
        }
    }
</script>
{% endblock %}
{% block extra_style %}
<style type="text/css">
    /* Some basic happy style */
    body{margin:50px 0px; padding:0px;text-align:center;}
    input {font-size:18px;}
    #myMap{width: 650px; height: 400px;margin:auto;margin-top:20px;}
</style>
{% endblock %}
{% block content %}
    <h1>Participants</h1>
    <!-- Map Placeholder -->
    <div id="myMap"></div>
{% endblock %}
